function initApp(){"undefined"!=typeof google?ko.applyBindings(new ViewModel):googleError()}function googleError(){window.alert("Can't load google maps API")}var initLoc={geometry:{location:{lat:45.2405036,lng:9.529251199999976}},name:"London, United Kingdom"},wiki={url:"http://en.wikipedia.org/w/api.php?action=opensearch&format=json&callback=wikiCallback&search=",notFound:"<p>No wikipedia articles found</p>",load:'<p>Loading data <i class="fa fa-spinner fa-pulse"></i></p>',fail:"<p>Wikipedia search failed, try again</p>",limit:2},ViewModel=function(){function i(i){var o=new google.maps.places.PlacesService(t);o.nearbySearch({location:i,radius:500},function(i,o){if(o===google.maps.places.PlacesServiceStatus.OK)for(var n=0;n<i.length;n++)e(i[n]);else window.alert("Google places search failed at that moment, please try again")})}function e(i){var e=function(){var i=this;""!==this.wikiLinks()&&this.wikiLinks()!==wiki.fail||(this.wikiLinks(wiki.load),n(this)),o(this),a.infoWindow.open(t,this),this.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){i.setAnimation(null)},2100)},s=new google.maps.Marker({map:t,icon:"images/pointer.png",position:i.geometry.location,name:i.name,itemClick:e,wikiLinks:ko.observable("")});return google.maps.event.addListener(s,"click",e),a.markers.push(s),s}function o(i){"undefined"!=typeof a.infoWindow&&a.infoWindow.close();var e='<div id="info-window"><h3 data-bind="text: name"></h3><div id="wiki-content" data-bind="html: wikiLinks"></div></div>';a.infoWindow=new google.maps.InfoWindow({content:e});var o=!1;google.maps.event.addListener(a.infoWindow,"domready",function(){o||(ko.applyBindings(i,$("#info-window")[0]),o=!0)})}function n(i){var e=wiki.url+encodeURIComponent(i.name)+"&limit="+wiki.limit;$.ajax({url:e,dataType:"jsonp",jsonp:"callback",success:function(e){var o=e[1],n=e[3];if(0===o.length)return void i.wikiLinks(wiki.notFound);i.wikiLinks('<p>Wikipedia links:</p><ul class="wiki-list">');for(var a=0;a<o.length;a++)i.wikiLinks(i.wikiLinks()+'<li class="wiki-item"><a class="wiki-link" href="'+n[a]+'">'+o[a]+"</a></li>");i.wikiLinks(i.wikiLinks()+"</ul>")}}).fail(function(){i.wikiLinks(wiki.fail)})}var a=this;a.markers=ko.observableArray([]),a.initLocName=ko.observable(initLoc.name);var t=new google.maps.Map(document.getElementById("map"),{center:initLoc.geometry.location,zoom:16,fullscreenControl:!1,mapTypeControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}});new google.maps.places.Autocomplete(document.getElementById("place-search"));var s=document.getElementById("user-menu");t.controls[google.maps.ControlPosition.LEFT_TOP].push(s),a.isOpen=ko.observable(!1),a.toggleMenu=function(){a.isOpen(!a.isOpen())},a.newInitLoc=function(){for(var o=0;o<a.markers().length;o++)a.markers()[o].setMap(null);a.markers([]);var n=new google.maps.Geocoder,s=a.initLocName();""===s?window.alert("You must enter an area, or address."):n.geocode({address:s},function(o,n){if(n==google.maps.GeocoderStatus.OK){o[0].name=a.initLocName();var l=e(o[0]);l.setAnimation(google.maps.Animation.DROP),l.icon="images/pointer-icon.png",t.setCenter(o[0].geometry.location),i(o[0].geometry.location)}else window.alert("We could not find location "+s+".\nTry entering a more specific place.")})},a.query=ko.observable(""),a.query.subscribe(function(i){for(var e=!1,o=0;o<a.markers().length;o++){var n=a.markers()[o];n.name.toLowerCase().indexOf(i.toLowerCase())==-1?n.visible&&(n.setVisible(!1),e=!0):n.visible||(n.setVisible(!0),e=!0)}if(e){var t=a.markers();a.markers(null),a.markers(t),t=null}})};